<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tilers Directory | TILERSHUB</title>

  <!-- Shared site styles (optional) -->
  <link rel="stylesheet" href="/css/layout.css"/>

  <style>
    :root{
      --primary:#0052cc; --accent:#f8b400; --bg:#f5f7fb; --text:#222; --sub:#667085; --card:#fff; --border:#e6e8ee;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif; background:var(--bg); color:var(--text);}

    header, footer{padding:14px 16px}

    .container{max-width:1100px; margin:0 auto; padding:16px;}

    /* Toolbar */
    .toolbar{
      display:grid; gap:10px; grid-template-columns:1fr; margin-bottom:14px;
    }
    @media(min-width:680px){
      .toolbar{grid-template-columns: 1.2fr 0.9fr 0.9fr;}
    }
    .toolbar input,.toolbar select{
      width:100%; padding:12px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; font-size:14px;
      outline:none;
    }

    /* Cards list */
    .list{display:flex; flex-direction:column; gap:12px;}

    /* Horizontal card */
    .card{
      display:grid; grid-template-columns:92px 1fr; gap:12px;
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px;
      box-shadow:0 1px 0 rgba(16,24,40,.02);
    }
    @media(min-width:560px){
      .card{grid-template-columns:120px 1fr;}
    }

    .avatar-wrap{position:relative}
    .avatar{
      width:100%; aspect-ratio:1/1; border-radius:12px; background:#eef1f6; object-fit:cover;
      border:1px solid var(--border);
    }
    .badge{
      position:absolute; left:8px; top:8px; background:var(--accent); color:#fff; font-size:12px; font-weight:700;
      padding:4px 8px; border-radius:999px; box-shadow:0 2px 8px rgba(0,0,0,.08);
    }

    .meta{display:flex; flex-direction:column; gap:6px; min-width:0}
    .title-row{display:flex; align-items:center; gap:8px; min-width:0}
    .name{font-size:18px; font-weight:700; line-height:1.2; text-wrap:balance; margin:0}
    .city{color:var(--sub); font-size:14px}

    .stars{color:var(--accent); font-variation-settings:"FILL" 1; font-size:14px; letter-spacing:.5px}
    .subgrid{
      display:grid; gap:8px; grid-template-columns:1fr; align-items:center;
    }
    @media(min-width:680px){
      .subgrid{grid-template-columns:1.4fr 1fr auto;}
    }

    .highlights{display:flex; flex-wrap:wrap; gap:6px}
    .chip{
      font-size:12px; padding:6px 10px; border-radius:999px; background:#f2f4f7; color:#344054; border:1px solid var(--border);
    }

    .counts{color:#475467; font-size:13px}
    .btn{
      appearance:none; border:none; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; gap:8px;
      background:var(--primary); color:#fff; padding:10px 14px; border-radius:10px; font-weight:700; font-size:14px; text-decoration:none;
      transition:transform .05s ease, filter .15s ease;
      white-space:nowrap;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#fff; color:#1d2939; border:1px solid var(--border)}
    .btn.block{width:100%}

    .empty{
      text-align:center; padding:18px; color:#667085; border:1px dashed var(--border); background:#fff; border-radius:12px;
    }

    /* Row of quick filters */
    .quick-filters{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 16px}
    .pill{
      padding:8px 12px; border-radius:999px; border:1px solid var(--border);
      background:#fff; color:#344054; font-size:13px; cursor:pointer;
    }
    .pill.active{background:#EEF4FF; border-color:#DBE3FF; color:#3538CD}

    /* Small helper */
    .muted{color:#98A2B3; font-size:13px}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0;}
  </style>
</head>
<body>

<!-- Header include -->
<div id="header"></div>

<main class="container">
  <h1 style="margin:6px 0 8px; font-size:22px;">Find a Verified Tiler</h1>
  <p class="muted" style="margin:0 0 12px;">Browse featured pros, filter by city, and tap <strong>Book Now</strong> to view each profile.</p>

  <!-- Toolbar -->
  <div class="toolbar">
    <input id="q" type="search" placeholder="Search by name, city, skill…" autocomplete="off"/>
    <select id="city">
      <option value="">All cities</option>
    </select>
    <select id="sort">
      <option value="featured">Featured first</option>
      <option value="rating_desc">Highest rating</option>
      <option value="reviews_desc">Most reviews</option>
      <option value="name_asc">Name A → Z</option>
    </select>
  </div>

  <!-- Quick filter pills (auto from highlights) -->
  <div id="pills" class="quick-filters" aria-label="Quick filters"></div>

  <!-- Cards -->
  <div id="list" class="list" role="list"></div>

  <div id="empty" class="empty" style="display:none">
    No tilers match your filters. Try clearing filters or searching a different term.
  </div>
</main>

<!-- Footer include -->
<div id="footer"></div>

<!-- Includes & App -->
<script src="/js/include.js"></script>

<script>
  // ---- Config / State ----
  const DATA_URL = "/tilers/tilers.json";   // must be deployed and public
  let ALL = [];      // raw
  let FILTERED = []; // after filters
  let HIGHLIGHT_INDEX = []; // for pills

  // Small utils
  const $ = (s,p=document)=>p.querySelector(s);
  const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));
  const esc = (s)=>String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  const stars = (val)=> {
    const r = Math.round(Number(val||0));
    return "★".repeat(r) + "☆".repeat(5-r);
  };

  // Build quick unique list of highlights for pills
  function buildHighlightIndex(data){
    const set = new Set();
    data.forEach(t => (t.highlights||[]).forEach(h => set.add(h)));
    return Array.from(set).sort();
  }

  // Populate city dropdown
  function populateCityOptions(data){
    const citySel = $("#city");
    const cities = Array.from(new Set(data.map(t => t.city).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
    cities.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c; opt.textContent = c;
      citySel.appendChild(opt);
    });
  }

  // Build pills
  function renderPills(){
    const pills = $("#pills");
    pills.innerHTML = "";
    HIGHLIGHT_INDEX.slice(0,18).forEach(h => {
      const b = document.createElement("button");
      b.className = "pill"; b.type="button"; b.textContent = h;
      b.dataset.val = h;
      b.addEventListener("click", () => {
        b.classList.toggle("active");
        applyAndRender();
      });
      pills.appendChild(b);
    });
  }

  // Core filter/sort
  function computeFiltered(){
    const q = $("#q").value.trim().toLowerCase();
    const city = $("#city").value;
    const activePills = $$(".pill.active").map(n => n.dataset.val);
    const sort = $("#sort").value;

    let rows = [...ALL];

    if (q){
      rows = rows.filter(t => {
        const hay = [
          t.name, t.city, (t.bio||""), ...(t.highlights||[])
        ].join(" ").toLowerCase();
        return hay.includes(q);
      });
    }
    if (city){
      rows = rows.filter(t => String(t.city).toLowerCase() === city.toLowerCase());
    }
    if (activePills.length){
      rows = rows.filter(t => {
        const hs = new Set(t.highlights||[]);
        return activePills.every(p => hs.has(p));
      });
    }

    // sort
    switch (sort){
      case "rating_desc":
        rows.sort((a,b) => (b.rating||0) - (a.rating||0));
        break;
      case "reviews_desc":
        rows.sort((a,b) => (b.reviewCount||0) - (a.reviewCount||0));
        break;
      case "name_asc":
        rows.sort((a,b) => String(a.name).localeCompare(String(b.name)));
        break;
      case "featured":
      default:
        rows.sort((a,b) => {
          // featured first; then rating desc; then reviews desc; then name
          const fa = a.featured?1:0, fb=b.featured?1:0;
          if (fb!==fa) return fb-fa;
          const r = (b.rating||0)-(a.rating||0); if (r) return r;
          const rc = (b.reviewCount||0)-(a.reviewCount||0); if (rc) return rc;
          return String(a.name).localeCompare(String(b.name));
        });
        break;
    }

    FILTERED = rows;
  }

  // Render list
  function renderList(){
    const list = $("#list");
    const empty = $("#empty");
    list.innerHTML = "";

    if (!FILTERED.length){
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";

    FILTERED.forEach(t => {
      const img = t.image || "/tilers/images/placeholder.jpg";
      const cover = t.cover || "/tilers/images/cover-placeholder.jpg";
      const rating = Number(t.rating||0);
      const reviews = Number(t.reviewCount||0);
      const hl = (t.highlights||[]).slice(0,3);

      const item = document.createElement("article");
      item.className = "card"; item.role = "listitem";

      item.innerHTML = `
        <div class="avatar-wrap">
          <img class="avatar" loading="lazy" src="${esc(img)}" alt="${esc(t.name)}"/>
          ${t.featured ? `<span class="badge" title="TILERSHUB Featured">Featured</span>` : ``}
        </div>

        <div class="meta">
          <div class="title-row">
            <h2 class="name">${esc(t.name)}</h2>
          </div>
          <div class="city">Verified Tiler – ${esc(t.city||"")}</div>

          <div class="subgrid">
            <div class="highlights">
              ${hl.map(h=>`<span class="chip">${esc(h)}</span>`).join("")}
            </div>

            <div class="counts">
              <span class="stars" aria-label="${rating} out of 5">${stars(rating)}</span>
              <span class="muted">(${reviews} reviews)</span>
            </div>

            <a class="btn" href="/tilers/profile.html?id=${encodeURIComponent(t.id)}" aria-label="Book ${esc(t.name)} now">
              Book Now
            </a>
          </div>
        </div>
      `;

      list.appendChild(item);
    });
  }

  function applyAndRender(){
    computeFiltered();
    renderList();
  }

  async function loadData(){
    try{
      const res = await fetch(DATA_URL, {cache:"no-cache"});
      if(!res.ok) throw new Error("Failed to fetch tilers.json");
      const data = await res.json();

      // Basic validation
      if (!Array.isArray(data)) throw new Error("tilers.json must be an array");

      ALL = data;
      HIGHLIGHT_INDEX = buildHighlightIndex(ALL);
      populateCityOptions(ALL);
      renderPills();
      applyAndRender();
    }catch(err){
      console.error(err);
      $("#list").innerHTML = `<div class="empty">Could not load tilers list. Make sure <code>${esc(DATA_URL)}</code> exists and is public.</div>`;
    }
  }

  // Wire inputs
  function bindUI(){
    $("#q").addEventListener("input", applyAndRender);
    $("#city").addEventListener("change", applyAndRender);
    $("#sort").addEventListener("change", applyAndRender);
  }

  // Boot
  document.addEventListener("DOMContentLoaded", () => {
    bindUI();
    loadData();
  });

  // If your include.js fires this when header/footer are ready, no harm:
  document.addEventListener("includes:ready", () => {});
</script>

</body>
</html>