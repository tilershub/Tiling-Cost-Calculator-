<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tiler Profile | TILERSHUB</title>
  <style>
    :root { --primary:#0052cc; --accent:#f8b400; --light-bg:#f9f9f9; --text:#333; --border:#ddd; }
    body { margin:0; font-family:'Segoe UI', Tahoma, sans-serif; background:var(--light-bg); color:var(--text); }
    header, footer { text-align:center; padding:15px; }
    header{ background:var(--primary); color:#fff; }
    footer{ background:#222; color:#ccc; font-size:14px; }
    .cover{ height:150px; background-size:cover; background-position:center; }
    .profile-pic{ width:100px; height:100px; border-radius:50%; border:4px solid #fff; margin-top:-50px; background-size:cover; background-position:center; margin-left:auto; margin-right:auto;}
    .profile-info{ text-align:center; padding:10px 20px; }
    .stars{ color:var(--accent); font-size:1.2em; margin:5px 0; }
    .bio{ font-size:14px; color:#555; margin-top:8px; }
    .highlight-tag{ display:inline-block; background:var(--accent); color:#fff; padding:5px 12px; border-radius:20px; font-size:12px; margin:5px 4px; }
    .container{ padding:20px; max-width:600px; margin:auto; }
    .card{ background:#fff; padding:15px; border-radius:10px; box-shadow:0 0 5px rgba(0,0,0,.05); margin-bottom:20px; }
    .rating-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(150px,1fr)); gap:10px; margin-top:10px; }
    .rating-grid div{ background:#f1f3f6; padding:10px; border-radius:6px; text-align:center; font-weight:500; }
    input, select, textarea{ width:100%; margin:8px 0; padding:10px; border-radius:6px; border:1px solid var(--border); font-size:14px; }
    button{ background:var(--primary); color:#fff; border:none; padding:12px; width:100%; border-radius:6px; font-size:16px; margin-top:10px; cursor:pointer; }
    .review-card{ border-top:1px solid #eee; margin-top:10px; padding-top:10px; }
    small{ color:#888; }
    .muted{ color:#888; font-size:14px; }
    a.link{ color:var(--accent); text-decoration:none; }
    .hidden { display:none !important; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // TODO: Replace with your Supabase project credentials
    const SUPABASE_URL = "https://lkrpuxshoxtmgiameane.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxrcnB1eHNob3h0bWdpYW1lYW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMDAwMzcsImV4cCI6MjA3MDY3NjAzN30.GfzGPHSp6wzKQ8qX0sxwH7IAeg2SdkQQeoN1VEMKOxY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Moderation mode: if true, new reviews insert with approved=false (update policy in DB accordingly)
    const MODERATED = false; // set to true if you want manual approval

    const urlParams = new URLSearchParams(window.location.search);
    const tilerId = urlParams.get("id");

    // ---- UTIL ----
    function escapeHtml(str){ return String(str||"").replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }
    function percentFrom5(avg){ return Math.round((avg/5)*100) + "%"; }
    function starsFromAvg(avg){ const r = Math.round(avg||0); return "★".repeat(r) + "☆".repeat(5-r); }
    function avgOfRow(r){
      return ( (r.quality||0)+(r.service||0)+(r.timeline||0)+(r.pricing||0)+(r.cleanliness||0) )/5;
    }

    // ---- PROFILE ----
    async function loadTilerProfile(){
      try{
        const res = await fetch("/tilers/tilers.json");
        const data = await res.json();
        const tiler = data.find(t => String(t.id) === String(tilerId));
        if(!tiler){
          document.getElementById("tilerName").textContent = "Tiler not found";
          document.querySelector(".container").insertAdjacentHTML("afterbegin",
            `<div class="card"><p class="muted">Invalid or missing tiler id.</p></div>`);
          return;
        }
        document.title = tiler.name + " | TILERSHUB";
        document.getElementById("tilerName").textContent = tiler.name;
        document.getElementById("tilerCity").textContent = "Verified Tiler – " + (tiler.city||"");
        document.getElementById("bioText").textContent = tiler.bio || "";
        document.getElementById("highlightTags").innerHTML = (tiler.highlights||[])
          .map(h=>`<span class="highlight-tag">${escapeHtml(h)}</span>`).join("");
        document.getElementById("coverImage").style.backgroundImage = `url('${tiler.cover || "/default-cover.jpg"}')`;
        document.getElementById("profilePic").style.backgroundImage = `url('${tiler.image}')`;
        document.getElementById("whatsappLink").href = "https://wa.me/94" + String(tiler.whatsapp||"").replace(/\D/g,"").replace(/^0/,"");
        document.getElementById("whatsappLink").textContent = "WhatsApp " + tiler.name;
      }catch(e){ console.error(e); }
    }

    // ---- REVIEWS LOAD ----
    async function loadReviews(){
      if(!tilerId){ renderEmptySummary(); return; }
      const { data, error } = await supabase
        .from("reviews")
        .select("*")
        .eq("tiler_id", tilerId)
        .eq("approved", true)
        .order("created_at",{ascending:false});
      if(error){ console.error(error); renderEmptySummary(); renderReviews([]); return; }
      renderSummary(data);
      renderReviews(data);
    }

    function renderEmptySummary(){
      document.querySelector(".rating-grid").innerHTML = `
        <div>Quality of Work: —</div>
        <div>Customer Service: —</div>
        <div>Timeliness: —</div>
        <div>Pricing Fairness: —</div>
        <div>Cleanliness: —</div>
        <div><strong>No reviews yet</strong></div>`;
      document.getElementById("ratingStars").innerHTML = "☆☆☆☆☆";
    }

    function renderSummary(rows){
      if(!rows.length){ renderEmptySummary(); return; }
      const n = rows.length;
      const sum = rows.reduce((a,r)=>({
        q:a.q+(r.quality||0),
        s:a.s+(r.service||0),
        t:a.t+(r.timeline||0),
        p:a.p+(r.pricing||0),
        c:a.c+(r.cleanliness||0)
      }),{q:0,s:0,t:0,p:0,c:0});
      const avgQ=sum.q/n, avgS=sum.s/n, avgT=sum.t/n, avgP=sum.p/n, avgC=sum.c/n;
      const avgStars=(avgQ+avgS+avgT+avgP+avgC)/5;
      const recommends = Math.round((rows.filter(r=>avgOfRow(r)>=4).length/n)*100);

      document.querySelector(".rating-grid").innerHTML = `
        <div>Quality of Work: ${percentFrom5(avgQ)}</div>
        <div>Customer Service: ${percentFrom5(avgS)}</div>
        <div>Timeliness: ${percentFrom5(avgT)}</div>
        <div>Pricing Fairness: ${percentFrom5(avgP)}</div>
        <div>Cleanliness: ${percentFrom5(avgC)}</div>
        <div><strong>${recommends}% recommends this tiler</strong></div>`;
      document.getElementById("ratingStars").innerHTML = starsFromAvg(avgStars);
    }

    function renderReviews(rows){
      const list = document.getElementById("reviewList");
      list.querySelectorAll(".review-card").forEach(n=>n.remove());
      rows.forEach(r=>{
        const avg = Math.round(avgOfRow(r));
        const created = new Date(r.created_at).toISOString().split("T")[0];
        const phone = r.phone ? escapeHtml(r.phone) : "N/A";
        const email = r.email ? escapeHtml(r.email) : "N/A";
        const comment = escapeHtml(r.comment||"");
        const name = escapeHtml(r.name||"Anonymous");
        list.insertAdjacentHTML("beforeend", `
          <div class="review-card">
            <strong>${name}</strong> <small>– ${created}</small>
            <div class="stars">${"★".repeat(avg)}${"☆".repeat(5-avg)}</div>
            ${comment ? `<p>${comment}</p>` : ``}
            ${(r.phone||r.email) ? `<p><small>Phone: ${phone} | Email: ${email}</small></p>` : ``}
          </div>`);
      });
    }

    // ---- REVIEW SUBMIT ----
    async function submitReview(){
      if(!tilerId){ return alert("Missing tiler id."); }
      const btn = document.getElementById("submitBtn");
      btn.disabled = true;

      // honeypot (simple anti-spam)
      if(document.getElementById("website").value.trim()){
        btn.disabled = false;
        return; // silently drop bots
      }

      const name = document.getElementById("name").value.trim() || "Anonymous";
      const phone = document.getElementById("phone").value.trim() || null;
      const email = document.getElementById("email").value.trim() || null;
      const quality = parseInt(document.getElementById("quality").value,10)||5;
      const service = parseInt(document.getElementById("service").value,10)||5;
      const timeline = parseInt(document.getElementById("timeline").value,10)||5;
      const pricing = parseInt(document.getElementById("pricing").value,10)||5;
      const cleanliness = parseInt(document.getElementById("cleanliness").value,10)||5;
      const comment = document.getElementById("comment").value.trim() || null;

      const ratings = [quality,service,timeline,pricing,cleanliness];
      if(!ratings.every(v=>v>=1 && v<=5)){
        btn.disabled=false; return alert("Please select valid ratings (1–5).");
      }

      const payload = { tiler_id: tilerId, name, phone, email, quality, service, timeline, pricing, cleanliness, comment };
      if(MODERATED){ payload.approved = false; }

      const { error } = await supabase.from("reviews").insert([payload]);
      if(error){ console.error(error); btn.disabled=false; return alert("Could not submit review. Please try again."); }

      // reset form
      ["name","phone","email","comment"].forEach(id=>document.getElementById(id).value="");
      ["quality","service","timeline","pricing","cleanliness"].forEach(id=>document.getElementById(id).value="5");

      if(MODERATED){
        alert("Thanks! Your review will be visible after approval.");
      }else{
        await loadReviews();
        alert("Review submitted.");
      }
      btn.disabled=false;
    }
    window.submitReview = submitReview;

    // ---- BOOT ----
    document.addEventListener("DOMContentLoaded", async ()=>{
      await loadTilerProfile();
      await loadReviews();
    });
  </script>
</head>
<body>

<header>
  <strong>TILERSHUB</strong><br/>Verified Tiler Profile
</header>

<div class="cover" id="coverImage"></div>

<div class="profile-info">
  <div class="profile-pic" id="profilePic"></div>
  <h2 id="tilerName">Loading...</h2>
  <p id="tilerCity">City</p>
  <div class="stars" id="ratingStars">★★★★★</div>
  <div class="bio" id="bioText">Loading bio...</div>
  <div id="highlightTags"></div>
</div>

<div class="container">
  <div class="card">
    <h3>Review Summary</h3>
    <div class="rating-grid">
      <div>Quality of Work: —</div>
      <div>Customer Service: —</div>
      <div>Timeliness: —</div>
      <div>Pricing Fairness: —</div>
      <div>Cleanliness: —</div>
      <div><strong>No reviews yet</strong></div>
    </div>
  </div>

  <div class="card" id="reviewList">
    <h3>Customer Reviews</h3>
    <!-- reviews injected here -->
  </div>

  <div class="card">
    <h3>Leave a Review</h3>

    <!-- Honeypot field (hidden from users) -->
    <input id="website" class="hidden" type="text" autocomplete="off" tabindex="-1" aria-hidden="true"/>

    <input type="text" id="name" placeholder="Your name" />
    <input type="tel" id="phone" placeholder="Your phone number (optional)" />
    <input type="email" id="email" placeholder="Your email address (optional)" />

    <label>Quality of Work</label>
    <select id="quality">
      <option value="5">5 - Excellent</option>
      <option value="4">4 - Good</option>
      <option value="3">3 - Average</option>
      <option value="2">2 - Poor</option>
      <option value="1">1 - Very Poor</option>
    </select>

    <label>Customer Service</label>
    <select id="service">
      <option value="5">5 - Excellent</option>
      <option value="4">4 - Good</option>
      <option value="3">3 - Average</option>
      <option value="2">2 - Poor</option>
      <option value="1">1 - Very Poor</option>
    </select>

    <label>Timeline</label>
    <select id="timeline">
      <option value="5">5 - On time</option>
      <option value="4">4 - Slight delay</option>
      <option value="3">3 - Delayed</option>
      <option value="2">2 - Late</option>
      <option value="1">1 - Very late</option>
    </select>

    <label>Pricing Fairness</label>
    <select id="pricing">
      <option value="5">5 - Very fair</option>
      <option value="4">4 - Fair</option>
      <option value="3">3 - Average</option>
      <option value="2">2 - Pricey</option>
      <option value="1">1 - Overpriced</option>
    </select>

    <label>Cleanliness</label>
    <select id="cleanliness">
      <option value="5">5 - Excellent</option>
      <option value="4">4 - Good</option>
      <option value="3">3 - Average</option>
      <option value="2">2 - Poor</option>
      <option value="1">1 - Very Poor</option>
    </select>

    <textarea id="comment" rows="3" placeholder="Write your feedback (optional)..."></textarea>
    <button id="submitBtn" onclick="submitReview()">Submit Review</button>

    <p class="muted">By submitting you agree to our <a class="link" href="/privacy">Privacy Policy</a>.</p>
  </div>
</div>

<footer>
  &copy; 2025 TILERSHUB |
  <a href="/privacy" class="link">Privacy Policy</a> |
  <a id="whatsappLink" href="#" class="link">WhatsApp</a>
</footer>

</body>
</html>