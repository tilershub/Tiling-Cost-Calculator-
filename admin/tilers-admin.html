<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TILERSHUB ‚Äî Tilers JSON Admin</title>
<style>
  :root { --bg:#0b1220; --panel:#11192b; --muted:#97a0b5; --text:#e9edf7; --accent:#42b883; --danger:#ff5d5d; --border:#21314d; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial}
  header{position:sticky;top:0;background:rgba(11,18,32,.9);backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid var(--border);z-index:9}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  h1{margin:0;font-size:18px;display:flex;gap:10px;align-items:center}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
  button,.btn{background:#1b2742;border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer}
  button:hover{border-color:#2b436c}
  .btn-accent{background:var(--accent);border:0;color:#07131a}
  .btn-danger{background:var(--danger);border:0;color:#1b0005}
  .btn-ghost{background:transparent;border:1px dashed var(--border)}
  .grid{display:grid;gap:16px}
  .panels{display:grid;grid-template-columns:320px 1fr;gap:16px;margin-top:16px}
  @media(max-width:960px){.panels{grid-template-columns:1fr}}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
  .search{display:flex;gap:8px}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0f1626;color:var(--text)}
  textarea{min-height:120px}
  .list{display:flex;flex-direction:column;gap:8px;max-height:65vh;overflow:auto}
  .card{display:flex;gap:10px;padding:10px;border:1px solid var(--border);border-radius:12px;align-items:center}
  .card small{color:var(--muted)}
  .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 8px;background:#0f1a2e;border:1px solid var(--border);border-radius:999px;font-size:12px}
  .tags{display:flex;flex-wrap:wrap;gap:8px}
  .flex{display:flex;gap:8px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .muted{color:var(--muted)}
  .danger{color:var(--danger)}
  .footer{margin-top:16px;color:var(--muted);font-size:12px}
  .divider{height:1px;background:var(--border);margin:12px 0}
  .inline{display:flex;align-items:center;gap:8px}
  .switch{display:inline-flex;align-items:center;gap:8px}
  .switch input{width:auto}
  .hlp{font-size:12px;color:var(--muted)}
  .error{background:#2b0f16;border:1px solid #6b1e2b;color:#ffd3da;padding:10px;border-radius:10px;white-space:pre-wrap}
  .success{background:#0f2b1b;border:1px solid #1e6b3c;color:#d8ffea;padding:10px;border-radius:10px;white-space:pre-wrap}
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .kpi .panel{padding:12px;text-align:center}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
  .sticky-actions{position:sticky;bottom:0;background:var(--panel);border-top:1px solid var(--border);padding:10px;margin:12px -14px -14px;border-bottom-left-radius:14px;border-bottom-right-radius:14px;display:flex;gap:8px;justify-content:flex-end}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üõ†Ô∏è TILERSHUB ‚Äî Tilers JSON Admin</h1>
    <div class="toolbar">
      <button id="btnImport">Import JSON</button>
      <button id="btnPaste">Paste JSON</button>
      <button id="btnValidate">Validate</button>
      <button id="btnExport" class="btn-accent">Export JSON</button>
      <button id="btnCopy" class="btn">Copy JSON</button>
      <button id="btnReset" class="btn-ghost">Reset (Draft)</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="kpi">
    <div class="panel"><div class="muted">Total Tilers</div><div id="kpiCount" style="font-size:24px">0</div></div>
    <div class="panel"><div class="muted">Featured</div><div id="kpiFeatured" style="font-size:24px">0</div></div>
    <div class="panel"><div class="muted">Avg Rating</div><div id="kpiRating" style="font-size:24px">0</div></div>
    <div class="panel"><div class="muted">Cities</div><div id="kpiCities" style="font-size:24px">0</div></div>
  </div>

  <div class="panels">
    <!-- Left: list and actions -->
    <section class="panel">
      <div class="search">
        <input id="search" placeholder="Search by name, city, id‚Ä¶" />
        <select id="sort">
          <option value="name">Sort: Name</option>
          <option value="city">Sort: City</option>
          <option value="rating">Sort: Rating</option>
          <option value="reviewCount">Sort: Reviews</option>
          <option value="featured">Sort: Featured</option>
        </select>
      </div>
      <div class="divider"></div>

      <div class="list" id="list"></div>
      <div class="divider"></div>
      <button id="btnAdd" class="btn-accent">+ Add New Tiler</button>
      <div class="footer">Drafts are auto-saved to your browser. Export to update your live `tilers.json`.</div>
    </section>

    <!-- Right: editor -->
    <section class="panel">
      <div class="grid" id="editor" style="display:none">
        <div class="row">
          <div>
            <label>ID (slug) <span class="hlp">e.g., saman-anurudda</span></label>
            <input id="id" />
          </div>
          <div>
            <label>Name</label>
            <input id="name" />
          </div>
        </div>
        <div class="row3">
          <div><label>City</label><input id="city" /></div>
          <div><label>WhatsApp</label><input id="whatsapp" /></div>
          <div><label>Facebook URL</label><input id="facebook" /></div>
        </div>
        <div class="row">
          <div><label>Image Path</label><input id="image" placeholder="/tilers/images/tilers/xxx.png" /></div>
          <div><label>Cover Path</label><input id="cover" placeholder="/tilers/images/tilers/xxx-banner.jpg" /></div>
        </div>
        <div class="row3">
          <div><label>Rating (0‚Äì5)</label><input id="rating" type="number" step="0.1" min="0" max="5" /></div>
          <div><label>Review Count</label><input id="reviewCount" type="number" step="1" min="0" /></div>
          <div class="switch"><input id="featured" type="checkbox" /> <label for="featured">Featured</label></div>
        </div>

        <div>
          <label>Bio (supports line breaks)</label>
          <textarea id="bio" placeholder="Short professional bio"></textarea>
          <div class="hlp">Tip: your site can render newlines with <code class="mono">white-space: pre-line;</code></div>
        </div>

        <div>
          <label>Highlights</label>
          <div class="tags" id="highlights"></div>
          <div class="flex">
            <input id="newHighlight" placeholder="Add highlight (Enter)" />
            <button id="btnAddHighlight">Add</button>
          </div>
        </div>

        <div class="sticky-actions">
          <button id="btnGenerateId" title="Generate ID from Name">Generate ID</button>
          <button id="btnDelete" class="btn-danger">Delete</button>
          <button id="btnSave" class="btn-accent">Save Changes</button>
        </div>
      </div>

      <div id="emptyState">
        <p class="muted">Select a tiler on the left to edit ‚Äî or click ‚ÄúAdd New Tiler‚Äù.</p>
      </div>

      <div id="messages" style="margin-top:10px"></div>
    </section>
  </div>
</main>

<input type="file" id="fileInput" accept="application/json" hidden />

<script>
/* ----------------- Utilities ----------------- */
const $ = (sel)=>document.querySelector(sel);
const $$ = (sel)=>document.querySelectorAll(sel);
const ById = (id)=>document.getElementById(id);
const slugify = s => s.toLowerCase().normalize('NFKD').replace(/[^\w\s-]/g,'').trim().replace(/\s+/g,'-');
const deepClone = obj => JSON.parse(JSON.stringify(obj));
const defaultItem = () => ({
  id:"", name:"", city:"", image:"", cover:"",
  facebook:"", whatsapp:"", featured:false, rating:0, reviewCount:0,
  bio:"", highlights:[]
});
const STORAGE_KEY = "tilers_admin_draft_v1";
let data = [];
let filtered = [];
let selectedIndex = -1;
let dirty = false;

/* ------------- Load initial (empty) or from storage ------------- */
(function init(){
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    try { data = JSON.parse(saved); } catch(e){}
  }
  render();
  updateKpis();
  window.addEventListener('beforeunload', (e)=>{
    if (dirty) { e.preventDefault(); e.returnValue = ""; }
  });
})();

/* ----------------- Schema Validation ----------------- */
function validate(arr) {
  const errors = [];
  if (!Array.isArray(arr)) return ["Root must be an array"];

  const seenIds = new Set();
  arr.forEach((t, i)=>{
    const p = `Item ${i+1} (${t.name || t.id || "no-id"})`;
    if (!t.id) errors.push(`${p}: "id" is required`);
    if (t.id && seenIds.has(t.id)) errors.push(`${p}: duplicate id "${t.id}"`);
    seenIds.add(t.id);
    if (!t.name) errors.push(`${p}: "name" is required`);
    ["city","image","cover","facebook","whatsapp","bio"].forEach(k=>{
      if (typeof t[k] !== "string") errors.push(`${p}: "${k}" must be a string`);
    });
    if (!Array.isArray(t.highlights)) errors.push(`${p}: "highlights" must be an array of strings`);
    if (typeof t.featured !== "boolean") errors.push(`${p}: "featured" must be boolean`);
    if (typeof t.rating !== "number" || t.rating < 0 || t.rating > 5) errors.push(`${p}: "rating" must be 0‚Äì5`);
    if (!Number.isInteger(t.reviewCount) || t.reviewCount < 0) errors.push(`${p}: "reviewCount" must be integer ‚â• 0`);
  });
  return errors;
}

/* ----------------- Rendering ----------------- */
function render() {
  const q = ById('search').value?.toLowerCase() || "";
  const sort = ById('sort').value;
  filtered = data.filter(t=>{
    const hay = (t.name+" "+t.city+" "+t.id).toLowerCase();
    return hay.includes(q);
  }).sort((a,b)=>{
    if (sort==='rating') return (b.rating||0)-(a.rating||0);
    if (sort==='reviewCount') return (b.reviewCount||0)-(a.reviewCount||0);
    if (sort==='featured') return (b.featured?1:0)-(a.featured?1:0);
    return (""+(a[sort]||"")).localeCompare(""+(b[sort]||""));
  });

  const list = ById('list'); list.innerHTML = "";
  filtered.forEach((t, idx)=>{
    const card = document.createElement('div'); card.className = "card";
    card.innerHTML = `
      <div style="width:44px;height:44px;border-radius:8px;overflow:hidden;border:1px solid var(--border);background:#0f1626">
        ${t.image ? `<img src="${t.image}" style="width:100%;height:100%;object-fit:cover">` : ""}
      </div>
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;gap:8px">
          <strong>${t.name || "<unnamed>"}</strong>
          ${t.featured ? `<span class="pill">Featured</span>` : ""}
        </div>
        <small class="muted">${t.city || "‚Äî"} ‚Ä¢ ‚≠ê ${t.rating ?? 0} ‚Ä¢ ${t.reviewCount ?? 0} reviews</small><br/>
        <small class="muted mono">${t.id || ""}</small>
      </div>
      <div class="inline">
        <button data-act="edit">Edit</button>
        <button class="btn-ghost" data-act="dup">Duplicate</button>
      </div>
    `;
    card.addEventListener('click',(e)=>{
      const act = e.target?.dataset?.act;
      if (act === 'dup') { duplicateTiler(t); e.stopPropagation(); return; }
      selectById(t.id);
    });
    list.appendChild(card);
  });

  // restore selection if exists
  if (selectedIndex>=0) {
    const selId = data[selectedIndex]?.id;
    if (selId) selectById(selId, /*keepScroll*/true);
  }

  updateKpis();
}

function updateKpis(){
  ById('kpiCount').textContent = data.length;
  ById('kpiFeatured').textContent = data.filter(x=>x.featured).length;
  const avg = data.length ? (data.reduce((s,x)=>s+(x.rating||0),0)/data.length) : 0;
  ById('kpiRating').textContent = avg.toFixed(2);
  ById('kpiCities').textContent = new Set(data.map(x=>x.city).filter(Boolean)).size;
}

function selectById(id, keepScroll=false){
  const idx = data.findIndex(t=>t.id===id);
  if (idx===-1) return;
  selectedIndex = idx;
  const t = data[idx];
  ById('emptyState').style.display = "none";
  ById('editor').style.display = "block";
  ById('id').value = t.id || "";
  ById('name').value = t.name || "";
  ById('city').value = t.city || "";
  ById('whatsapp').value = t.whatsapp || "";
  ById('facebook').value = t.facebook || "";
  ById('image').value = t.image || "";
  ById('cover').value = t.cover || "";
  ById('rating').value = t.rating ?? 0;
  ById('reviewCount').value = t.reviewCount ?? 0;
  ById('featured').checked = !!t.featured;
  ById('bio').value = t.bio || "";
  renderHighlights(t.highlights||[]);
  if (!keepScroll) window.scrollTo({top:0, behavior:'smooth'});
}

function renderHighlights(arr){
  const host = ById('highlights'); host.innerHTML = "";
  (arr||[]).forEach((h,i)=>{
    const el = document.createElement('span');
    el.className = "pill";
    el.innerHTML = `<span>${h}</span> <button data-i="${i}" title="Remove">‚úï</button>`;
    el.querySelector('button').onclick = (e)=>{ removeHighlight(i); e.stopPropagation(); };
    host.appendChild(el);
  });
}

/* ----------------- Mutations ----------------- */
function markDirty(){ dirty = true; localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
function addHighlight(val){
  const v = (val||"").trim(); if (!v) return;
  const t = data[selectedIndex]; if (!t.highlights) t.highlights=[];
  t.highlights.push(v); markDirty(); renderHighlights(t.highlights); ById('newHighlight').value="";
}
function removeHighlight(i){
  const t = data[selectedIndex]; t.highlights.splice(i,1); markDirty(); renderHighlights(t.highlights);
}
function duplicateTiler(t){
  const c = deepClone(t);
  c.id = (c.id||"")+"-copy";
  c.name = (c.name||"")+" (Copy)";
  data.push(c); markDirty(); render(); selectById(c.id);
}
function addNew(){
  const n = defaultItem();
  n.id = "new-tiler-"+(Date.now());
  n.name = "New Tiler";
  data.unshift(n); markDirty(); render(); selectById(n.id);
}
function saveCurrent(){
  if (selectedIndex<0) return;
  const t = data[selectedIndex];
  const updated = {
    id: ById('id').value.trim(),
    name: ById('name').value.trim(),
    city: ById('city').value.trim(),
    whatsapp: ById('whatsapp').value.trim(),
    facebook: ById('facebook').value.trim(),
    image: ById('image').value.trim(),
    cover: ById('cover').value.trim(),
    rating: Number(ById('rating').value),
    reviewCount: parseInt(ById('reviewCount').value || "0",10),
    featured: ById('featured').checked,
    bio: ById('bio').value,
    highlights: deepClone(data[selectedIndex].highlights||[])
  };

  // ID collision check
  if (!updated.id) return flash(`ID is required`, true);
  const dup = data.findIndex((x, i)=> x.id===updated.id && i!==selectedIndex);
  if (dup !== -1) return flash(`Another tiler already uses the id "${updated.id}"`, true);

  // Quick numeric bounds
  if (updated.rating<0 || updated.rating>5) return flash(`Rating must be between 0 and 5`, true);
  if (!Number.isInteger(updated.reviewCount) || updated.reviewCount<0) return flash(`Review Count must be an integer ‚â• 0`, true);

  data[selectedIndex] = updated;
  markDirty();
  flash(`Saved changes to ‚Äú${updated.name}‚Äù`);
  render();
  selectById(updated.id, true);
}
function deleteCurrent(){
  if (selectedIndex<0) return;
  const t = data[selectedIndex];
  if (!confirm(`Delete ${t.name}? This cannot be undone.`)) return;
  data.splice(selectedIndex,1);
  selectedIndex = -1;
  markDirty();
  ById('editor').style.display="none";
  ById('emptyState').style.display="block";
  render();
  flash(`Deleted.`);
}
function generateIdFromName(){
  const name = ById('name').value.trim();
  if (!name) return flash("Enter a Name first", true);
  const id = slugify(name);
  ById('id').value = id;
  flash(`ID generated: ${id}`);
}

/* ----------------- Messages ----------------- */
function flash(msg, isError=false){
  const box = document.createElement('div');
  box.className = isError ? "error" : "success";
  box.textContent = msg;
  ById('messages').prepend(box);
  setTimeout(()=>box.remove(), 4000);
}

/* ----------------- Import/Export ----------------- */
ById('btnImport').onclick = ()=> ById('fileInput').click();
ById('fileInput').addEventListener('change', (e)=>{
  const file = e.target.files[0]; if (!file) return;
  file.text().then(txt=>{
    try{
      const arr = JSON.parse(txt);
      const errs = validate(arr);
      if (errs.length) return flash("Import failed:\n"+errs.join("\n"), true);
      data = arr; localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); dirty=false;
      render(); flash(`Imported ${data.length} records`);
    }catch(err){ flash("Invalid JSON: "+err.message, true); }
  });
});

ById('btnPaste').onclick = ()=>{
  const txt = prompt("Paste JSON array here:");
  if (!txt) return;
  try{
    const arr = JSON.parse(txt);
    const errs = validate(arr);
    if (errs.length) return flash("Paste failed:\n"+errs.join("\n"), true);
    data = arr; localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); dirty=false;
    render(); flash(`Loaded ${data.length} records from paste`);
  }catch(err){ flash("Invalid JSON: "+err.message, true); }
};

ById('btnValidate').onclick = ()=>{
  const errs = validate(data);
  if (errs.length) flash("Validation errors:\n"+errs.join("\n"), true);
  else flash("All good ‚úÖ");
};

ById('btnExport').onclick = ()=>{
  const errs = validate(data);
  if (errs.length) { flash("Fix errors before export:\n"+errs.join("\n"), true); return; }
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'tilers.json';
  a.click();
  URL.revokeObjectURL(a.href);
  dirty=false;
  flash("Exported tilers.json");
};

ById('btnCopy').onclick = ()=>{
  const errs = validate(data);
  if (errs.length) { flash("Fix errors before copy:\n"+errs.join("\n"), true); return; }
  navigator.clipboard.writeText(JSON.stringify(data, null, 2));
  flash("Copied JSON to clipboard");
};

ById('btnReset').onclick = ()=>{
  if (!confirm("Clear local draft and start empty?")) return;
  localStorage.removeItem(STORAGE_KEY);
  data = [];
  selectedIndex = -1; dirty=false;
  render();
  ById('editor').style.display="none";
  ById('emptyState').style.display="block";
  flash("Draft cleared");
};

/* ----------------- Events ----------------- */
ById('search').oninput = render;
ById('sort').onchange = render;
ById('btnAdd').onclick = addNew;
ById('btnSave').onclick = saveCurrent;
ById('btnDelete').onclick = deleteCurrent;
ById('btnGenerateId').onclick = generateIdFromName;
ById('btnAddHighlight').onclick = ()=> addHighlight(ById('newHighlight').value);
ById('newHighlight').addEventListener('keydown',(e)=>{ if (e.key==='Enter'){ addHighlight(e.target.value); } });

['id','name','city','whatsapp','facebook','image','cover','rating','reviewCount','featured','bio'].forEach(id=>{
  const el = ById(id);
  el && el.addEventListener(el.type==='checkbox'?'change':'input', ()=>{ dirty=true; });
});
</script>
</body>
</html>